[gd_scene load_steps=4 format=2]

[ext_resource path="res://OurGuy.png" type="Texture" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends KinematicBody2D

export var _HorizontalVelocity := 400.0
export var _GravityVelocity := 600
export var _JumpForce := 1300
export var _JumpingDuration := 0.25

var _IsJumping := false
var _GoingLeft := false

func _ready():
	$JumpTimer.one_shot = true

func changeSide():
	$Sprite.flip_h = not $Sprite.flip_h
	
func fixBoundary():
	var windowSize = get_viewport().size
	
	if self.position.y > windowSize.y:
		self.position.y = 0
	if self.position.x > windowSize.x:
		self.position.x = 0
	
	if self.position.x < $Sprite.get_rect().size.x*2: # Porque *2?
		self.position.x = $Sprite.get_rect().size.x*2

func _process(delta):
	var finalVelocity : Vector2 = Vector2(0,_GravityVelocity)
	var floorAngle : float
	
	if Input.is_action_pressed(\"ui_right\"):
		finalVelocity.x += _HorizontalVelocity
		if _GoingLeft:
			changeSide()
			_GoingLeft = false
	elif Input.is_action_pressed(\"ui_left\"):
		finalVelocity.x -= _HorizontalVelocity
		if not _GoingLeft:
			changeSide()
			_GoingLeft = true
	
	if Input.is_action_just_pressed(\"ui_accept\") && self.is_on_floor():
		_IsJumping = true
		$JumpTimer.start(_JumpingDuration)
	
	if _IsJumping:
		finalVelocity.y -= _JumpForce
		
		if finalVelocity.x == 0:
			if _GoingLeft:
				finalVelocity.x -= _HorizontalVelocity/2
			else:
				finalVelocity.x += _HorizontalVelocity/2
		
		self.move_and_slide(finalVelocity, Vector2.UP, true)
	else:
		floorAngle = get_floor_normal().angle()
		if is_on_floor():
			finalVelocity.y *= floorAngle
		self.move_and_slide_with_snap(finalVelocity, Vector2.DOWN*100, Vector2.UP, true)

	fixBoundary()
	print(finalVelocity.x)

func _on_JumpTimer_timeout():
	_IsJumping = false
"

[sub_resource type="CapsuleShape2D" id=2]
radius = 7.5
height = 16.2

[node name="OurGuy" type="KinematicBody2D"]
script = SubResource( 1 )

[node name="Sprite" type="Sprite" parent="."]
position = Vector2( 0, -79.7354 )
scale = Vector2( 5, 5 )
texture = ExtResource( 1 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( 0, -76.7354 )
scale = Vector2( 5, 5 )
shape = SubResource( 2 )

[node name="JumpTimer" type="Timer" parent="."]
[connection signal="timeout" from="JumpTimer" to="." method="_on_JumpTimer_timeout"]
